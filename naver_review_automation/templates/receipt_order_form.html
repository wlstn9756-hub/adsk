<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>영수증 작업 요청</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- 네비게이션 -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-900">영수증 작업 관리 시스템</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/receipt/dashboard" class="text-gray-700 hover:text-gray-900">내 작업 목록</a>
                    <a href="/receipt/order" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>새 작업 요청
                    </a>
                    <a href="/logout" class="text-red-600 hover:text-red-700">
                        <i class="fas fa-sign-out-alt mr-1"></i>로그아웃
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 작업 요청 폼 -->
    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <!-- 헤더 -->
            <div class="flex items-center mb-8">
                <i class="fas fa-receipt text-3xl text-blue-600 mr-4"></i>
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">영수증 작업 요청</h2>
                    <p class="text-gray-600">네이버 영수증 리뷰 작업을 요청해주세요</p>
                </div>
            </div>

            <form id="receiptOrderForm" class="space-y-6">
                <!-- 섹션 1: 업체 정보 -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-building text-gray-600 mr-2"></i>업체 정보
                    </h3>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- 상호명 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                상호명 <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   name="business_name"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="예: 스타벅스 강남점"
                                   required>
                        </div>

                        <!-- 대표자명 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                대표자명 <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   name="representative_name"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="홍길동"
                                   required>
                        </div>

                        <!-- 사업자번호 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                사업자번호 <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   name="business_number"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="123-45-67890"
                                   pattern="[0-9]{3}-[0-9]{2}-[0-9]{5}"
                                   required>
                        </div>

                        <!-- 업종 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                업종 <span class="text-red-500">*</span>
                            </label>
                            <select name="business_type"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required>
                                <option value="">선택하세요</option>
                                <option value="맛집">맛집</option>
                                <option value="일반">일반</option>
                            </select>
                        </div>

                        <!-- 플레이스 등록한 번호 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                플레이스 등록한 전화 번호 <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   name="place_number"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="예: 1234567890"
                                   required>
                        </div>

                        <!-- 플레이스 링크 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                플레이스 링크 <span class="text-red-500">*</span>
                            </label>
                            <input type="url"
                                   name="place_link"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="예: https://m.place.naver.com/place/1839653593"
                                   required>
                        </div>
                    </div>

                    <!-- 주소 -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            주소 <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               name="business_address"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="서울특별시 강남구 테헤란로 123"
                               required>
                    </div>
                </div>

                <!-- 섹션 2: 작업 일정 -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-calendar text-gray-600 mr-2"></i>작업 일정
                    </h3>

                    <!-- 날짜 정보 알림 -->
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                        <div class="flex">
                            <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                            <div>
                                <p class="text-sm text-blue-700">
                                    • 시작일은 접수일 다음날로 자동 설정됩니다.<br>
                                    • 종료일은 작업 일수에 따라 자동 계산됩니다 (주말 포함)<br>
                                    • 주말 접수시 월요일부터 작업 시작됩니다.<br>
                                    • 작성된 URL은 종료 이후 UI에서 업데이트 됩니다.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-4">
                        <div class="flex">
                            <i class="fas fa-exclamation-triangle text-amber-500 mr-2 mt-0.5"></i>
                            <div>
                                <p class="text-sm text-amber-800">
                                    <strong class="font-semibold">⚠️ 작업 기간 안내</strong><br>
                                    리뷰어들이 신청 후 작성을 지연하거나 작성하지 않는 경우도 간혹 발생하기 때문에,
                                    <strong class="font-bold text-amber-900">예정된 종료일 기준으로 최대 2~3일 정도 여유 기간이 추가로 소요될 수 있습니다.</strong>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- 접수일 (자동) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">접수일</label>
                            <input type="text"
                                   id="receipt_date"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100"
                                   readonly>
                        </div>

                        <!-- 시작일 (자동 계산) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                시작일 <span class="text-sm text-gray-500">(자동 계산)</span>
                            </label>
                            <input type="text"
                                   id="start_date"
                                   name="start_date"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100"
                                   readonly>
                        </div>

                        <!-- 하루 발행수 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                하루 발행수 <span class="text-red-500">*</span>
                            </label>
                            <input type="number"
                                   id="daily_count"
                                   name="daily_count"
                                   min="1"
                                   max="100"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   onchange="updateEndDate()"
                                   placeholder="10"
                                   required>
                        </div>

                        <!-- 작업 일수 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                작업 일수 <span class="text-red-500">*</span>
                            </label>
                            <input type="number"
                                   id="working_days"
                                   name="working_days"
                                   min="1"
                                   max="30"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   onchange="updateEndDate()"
                                   placeholder="5"
                                   required>
                        </div>

                        <!-- 종료일 (자동 계산) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                종료일 <span class="text-sm text-gray-500">(자동 계산)</span>
                            </label>
                            <input type="text"
                                   id="end_date"
                                   name="end_date"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100"
                                   readonly>
                        </div>

                        <!-- 총 작업량 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">총 작업량</label>
                            <div class="px-4 py-2 bg-blue-50 border-2 border-blue-200 rounded-lg">
                                <span class="text-xl font-bold text-blue-700">
                                    <span id="total_count">0</span>개
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 섹션 3: 이미지 첨부 -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-image text-gray-600 mr-2"></i>이미지 첨부 <span class="text-red-500">*</span>
                    </h3>

                    <div class="space-y-4">
                        <!-- 이미지 업로드 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                영수증 이미지 <span class="text-red-500">*</span>
                            </label>
                            <input type="file"
                                   id="attachmentImages"
                                   name="attachment_images"
                                   accept="image/jpeg,image/png,image/jpg"
                                   multiple
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   required>
                            <p class="text-xs text-gray-500 mt-1">
                                JPG, PNG 형식, 최대 5MB, 여러 장 업로드 가능 (최소 1장 필수)
                            </p>
                        </div>

                        <!-- 미리보기 영역 -->
                        <div id="imagePreview" class="grid grid-cols-3 gap-4 mt-4">
                            <!-- JavaScript로 동적 생성 -->
                        </div>
                    </div>
                </div>

                <!-- 섹션 4: 리뷰 자료 업로드 -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-file-alt text-gray-600 mr-2"></i>리뷰 자료 업로드 <span class="text-gray-400 text-xs">(선택사항)</span>
                    </h3>

                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                        <div class="flex">
                            <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                            <div>
                                <p class="text-sm text-blue-700 mb-2">
                                    <strong>리뷰 복붙멘트와 사진을 미리 준비하신 경우 업로드해주세요.</strong>
                                </p>
                                <p class="text-xs text-blue-600">
                                    • 파일 형식: 복붙멘트 | 사진번호 (예: 1,2,3)<br>
                                    • 사진 ZIP: 1.jpg, 2.jpg, 3.jpg... 형식으로 번호만 붙여주세요<br>
                                    • 사진은 선택사항이며, 멘트만 있어도 됩니다
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <!-- 예시 템플릿 다운로드 -->
                        <div class="flex gap-2">
                            <a href="/static/review_template.xlsx" download
                               class="inline-flex items-center px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm">
                                <i class="fas fa-download mr-2"></i>엑셀 템플릿 다운로드
                            </a>
                        </div>

                        <!-- 엑셀 파일 업로드 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                리뷰 멘트 파일 <span class="text-gray-400 text-xs">(선택)</span>
                            </label>
                            <input type="file"
                                   id="reviewExcel"
                                   name="review_excel"
                                   accept=".xlsx,.xls,.csv,.cell,.show,.hwp"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">
                                엑셀/한셀 파일 (.xlsx, .xls, .csv, .cell, .show, .hwp), 최대 10MB
                            </p>
                        </div>

                        <!-- 사진 ZIP 파일 업로드 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                리뷰 사진 ZIP 파일 <span class="text-gray-400 text-xs">(선택)</span>
                            </label>
                            <input type="file"
                                   id="reviewPhotos"
                                   name="review_photos"
                                   accept=".zip"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">
                                ZIP 파일, 최대 50MB (1.jpg, 2.jpg, 3.jpg... 형식으로 번호만)
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 섹션 5: 가이드라인 -->
                <div class="pb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-list-check text-gray-600 mr-2"></i>작업 가이드라인
                    </h3>

                    <div class="space-y-4">
                        <!-- 작성 가이드라인 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                작성 가이드라인 <span class="text-gray-400 text-xs">(선택사항)</span>
                            </label>
                            <textarea name="guidelines"
                                      rows="4"
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                      placeholder="리뷰 작성 시 지켜야 할 가이드라인을 입력하세요&#10;예: 메뉴명과 가격을 구체적으로 언급, 방문 시간대 명시"></textarea>
                        </div>

                    </div>
                </div>

                <!-- 제출 버튼 -->
                <div class="flex justify-end space-x-4 pt-6 border-t">
                    <button type="button"
                            onclick="window.location.href='/receipt/dashboard'"
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        취소
                    </button>
                    <button type="submit"
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
                        <i class="fas fa-paper-plane mr-2"></i>작업 요청
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 날짜 계산 함수
        function getNextStartDay(date) {
            const nextDay = new Date(date);

            // 금요일(5)이면 월요일로
            if (date.getDay() === 5) {
                nextDay.setDate(nextDay.getDate() + 3);
            } else {
                nextDay.setDate(nextDay.getDate() + 1);
            }

            return nextDay;
        }

        function calculateEndDate(startDate, days) {
            // 종료일 계산 (주말 포함, 단순히 일수 더하기)
            let date = new Date(startDate);
            date.setDate(date.getDate() + days - 1);
            return date;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const weekDay = ['일', '월', '화', '수', '목', '금', '토'][date.getDay()];
            return `${year}-${month}-${day} (${weekDay})`;
        }

        function updateEndDate() {
            const workingDays = parseInt(document.getElementById('working_days').value) || 0;
            const dailyCount = parseInt(document.getElementById('daily_count').value) || 0;

            if (workingDays > 0) {
                const startDateStr = document.getElementById('start_date').value;
                if (startDateStr) {
                    const startDate = new Date(startDateStr.split(' ')[0]);
                    const endDate = calculateEndDate(startDate, workingDays);
                    document.getElementById('end_date').value = formatDate(endDate);
                }
            }

            // 총 작업량 계산
            const totalCount = workingDays * dailyCount;
            document.getElementById('total_count').textContent = totalCount || 0;
        }

        // 이미지 미리보기
        document.getElementById('attachmentImages').addEventListener('change', function(e) {
            const previewContainer = document.getElementById('imagePreview');
            previewContainer.innerHTML = '';

            const files = Array.from(e.target.files);

            if (files.length === 0) return;

            files.forEach((file, index) => {
                // 파일 크기 체크 (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert(`${file.name}은(는) 5MB를 초과합니다.`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    const div = document.createElement('div');
                    div.className = 'relative border rounded-lg overflow-hidden';
                    div.innerHTML = `
                        <img src="${event.target.result}" class="w-full h-32 object-cover">
                        <button type="button"
                                class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs hover:bg-red-600"
                                onclick="removeImage(${index})">
                            ×
                        </button>
                        <p class="text-xs text-gray-600 p-1 truncate">${file.name}</p>
                    `;
                    previewContainer.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        });

        // 이미지 제거
        window.removeImage = function(index) {
            const input = document.getElementById('attachmentImages');
            const dt = new DataTransfer();
            const files = Array.from(input.files);

            files.forEach((file, i) => {
                if (i !== index) dt.items.add(file);
            });

            input.files = dt.files;
            input.dispatchEvent(new Event('change'));
        };

        // 페이지 로드 시 초기 설정
        window.onload = function() {
            const today = new Date();
            const startDate = getNextStartDay(today);

            document.getElementById('receipt_date').value = formatDate(today);
            document.getElementById('start_date').value = formatDate(startDate);
        }

        // 폼 제출
        document.getElementById('receiptOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // 이미지 파일 체크
            const imageInput = document.getElementById('attachmentImages');
            if (imageInput.files.length === 0) {
                alert('영수증 이미지를 최소 1장 업로드해주세요.');
                return;
            }

            const formData = new FormData(e.target);

            // 날짜 정보 추가
            formData.set('receipt_date', document.getElementById('receipt_date').value.split(' ')[0]);
            formData.set('start_date', document.getElementById('start_date').value.split(' ')[0]);
            formData.set('end_date', document.getElementById('end_date').value.split(' ')[0]);
            formData.set('total_count', document.getElementById('total_count').textContent);

            // 업종이 선택되지 않은 경우 기본값 설정
            if (!formData.get('business_type')) {
                formData.set('business_type', '일반');
            }

            try {
                const response = await fetch('/api/receipt/order', {
                    method: 'POST',
                    body: formData  // FormData 직접 전송 (Content-Type 자동 설정)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`작업 요청이 접수되었습니다.\n주문번호: ${result.order_no}`);
                    window.location.href = '/receipt/dashboard';
                } else {
                    alert(result.message || '작업 요청에 실패했습니다');
                }

            } catch (error) {
                alert('작업 처리 중 오류가 발생했습니다');
                console.error(error);
            }
        });
    </script>
</body>
</html>